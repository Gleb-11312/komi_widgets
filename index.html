<!doctype html>
<html lang="en"><head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Komi widgets — Translator · Assistant · Cards</title>
  <style>
    :root{
      --bg1:#e9f4ff;--bg2:#f7fbff;--card:#fff;--border:#dbe7f4;--ink:#0b1230;--muted:#6b7280;
      --accent:#16a34a;--accent2:#0ea5e9;--shadow:rgba(13,38,76,.10)
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));min-height:100vh}
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px}
    .brand{font-size:28px;margin:0 0 12px;font-weight:900}
    .brand .v{font-size:12px;font-weight:700;padding:2px 8px;border-radius:999px;margin-left:6px;
      background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
    .tabs{display:flex;gap:.5rem;margin:.25rem 0 1rem}
    .tab-btn{padding:.58rem 1.05rem;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .tab-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:none}
    .card{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:22px;box-shadow:0 16px 40px var(--shadow)}
    .title{font-size:20px;font-weight:800;margin-bottom:2px}.sub{color:var(--muted);font-size:14px;margin-bottom:10px}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    .btn{padding:.64rem 1rem;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:none}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .txt{width:100%;padding:.8rem;border-radius:14px;border:1px solid var(--border)}
    .out{min-height:52px;margin-top:10px;padding:12px;border-radius:14px;border:1px dashed #c7d5e6;background:#f3f8ff;font-size:18px}
    .badge{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#eef6ff;border:1px solid #d9e8f7;color:#194b7c;font-weight:600}
    .hint{font-size:12px;color:var(--muted)}
    .hidden{display:none}
    .meter{height:10px;background:#eef6ff;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:6px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .35s ease}

    /* Cards */
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
    .flip{perspective:1000px}
    .card3d{position:relative;height:120px;transform-style:preserve-3d;transition:transform .5s}
    .card3d.flipit{transform:rotateY(180deg)}
    .face{position:absolute;inset:0;border:1px solid var(--border);border-radius:16px;
          display:flex;align-items:center;justify-content:center;padding:12px;text-align:center;
          background:#fff;box-shadow:0 10px 24px var(--shadow);backface-visibility:hidden}
    .back{transform:rotateY(180deg);background:linear-gradient(180deg,#f7fbff,#eef6ff)}
    .toolbar{display:flex;gap:.5rem;margin:.75rem 0 0;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="brand">Komi widgets <span class="v">Translator · Assistant · Cards</span></h1>

    <div class="tabs">
      <button class="tab-btn active" data-tab="tr">Translator</button>
      <button class="tab-btn" data-tab="as">Assistant</button>
      <button class="tab-btn" data-tab="cd">Cards</button>
    </div>

    <!-- Translator -->
    <div id="tab-tr" class="card">
      <div class="title">English → Komi Translator (beta)</div>
      <div class="sub">Type a word or a short phrase in English. This translator returns Komi text.</div>
      <textarea id="src" class="txt" rows="3" placeholder="Type here..."></textarea>
      <div class="row" style="margin-top:.6rem">
        <button id="do" class="btn primary">Translate</button>
        <span id="hint" class="badge">Loading…</span>
      </div>
      <div id="out" class="out"></div>
    </div>

    <!-- Assistant -->
    <div id="tab-as" class="card hidden">
      <div class="title">Assistant (Speak Komi)</div>
      <div class="sub">We translate to Komi, play it in Komi, then you repeat and get a score.</div>
      <input id="as-text" class="txt" placeholder="Type an English word… e.g. hello" />
      <div class="row" style="margin-top:.6rem">
        <button id="as-say" class="btn">Play Komi</button>
        <button id="as-record" class="btn primary">Record & Check (ru-RU)</button>
        <span id="as-status" class="badge">Ready</span>
      </div>
      <div class="meter"><div id="as-bar" class="bar"></div></div>
      <div class="hint" id="as-hint"></div>
    </div>

    <!-- Cards -->
    <div id="tab-cd" class="card hidden">
      <div class="title">Cards (100)</div>
      <div class="sub">Click a card to flip (EN ⇄ Komi). Source: base dictionary + overlays.</div>
      <div class="toolbar">
        <button id="regen" class="btn">Regenerate</button>
        <span id="count" class="muted"></span>
      </div>
      <div id="grid" class="grid" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
    /* ------------ tabs ----------- */
    const tabs={tr:document.getElementById('tab-tr'), as:document.getElementById('tab-as'), cd:document.getElementById('tab-cd')};
    document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      tabs.tr.classList.toggle('hidden', b.dataset.tab!=='tr');
      tabs.as.classList.toggle('hidden', b.dataset.tab!=='as');
      tabs.cd.classList.toggle('hidden', b.dataset.tab!=='cd');
    }));
    const H=id=>document.getElementById(id);

    /* ----------- text utils ---------- */
    const norm = s => (s||'').toLowerCase().replace(/[.,!?;:()"“”']/g,' ').replace(/\s+/g,' ').trim();
    const toks = s => norm(s).split(' ').filter(Boolean);
    function mapLongest(tokens, dict, n=4){
      const out=[], unk=[]; let i=0;
      while(i<tokens.length){
        let hit=null,k=0;
        for(let m=Math.min(n,tokens.length-i); m>=1; m--){
          const p=tokens.slice(i,i+m).join(' ');
          if(dict[p]!==undefined){hit=dict[p];k=m;break;}
        }
        if(hit!==null){out.push(hit);i+=k;} else {out.push({__u:tokens[i]});unk.push(tokens[i]);i++;}
      }
      return {out,unk};
    }
    /* простой транслит на кириллицу — fallback для неизвестных */
    const dgs=[["sh","ш"],["ch","ч"],["zh","ж"],["kh","х"],["ts","ц"],["ya","я"],["yu","ю"],["yo","йо"],["ye","е"]];
    const cmap={"a":"а","b":"б","c":"к","d":"д","e":"е","f":"ф","g":"г","h":"х","i":"и","j":"дж","k":"к","l":"л","m":"м","n":"н","o":"о","p":"п","q":"к","r":"р","s":"с","t":"т","u":"у","v":"в","w":"в","x":"кс","y":"ы","z":"з","-":"-","'":"’"," ":" "};
    function translit(en){ let s=en.toLowerCase(); for(const [a,b] of dgs){ s=s.replaceAll(a,b);} let o=""; for(const ch of s){ o+=cmap[ch]??ch;} return o; }
    function finalize(ch){ const p=[]; for(const c of ch){ if(typeof c==='string') p.push(c); else if(c&&c.__u) p.push(translit(c.__u)); } return p.join(' ').replace(/\s+/g,' ').trim(); }

    /* -------- словарь + overlays ---------- */
    let DICT=null;  // EN->Komi
    async function fetchJSON(path){
      const r = await fetch(path, {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status+' '+path);
      return r.json();
    }

    async function loadOverlays(dict){
      // 1) попробуем manifest.json
      try{
        const mf = await fetchJSON('./data/overlays/manifest.json');
        if(Array.isArray(mf.files)){
          for(const f of mf.files){
            const j = await fetchJSON('./data/overlays/'+f);
            Object.assign(dict, j);
          }
          return;
        }
      }catch(e){ /* нет манифеста — ок */ }

      // 2) без манифеста — пробуем типовые имена
      const candidates = [
        ...Array.from({length:30},(_,i)=>`overlay_${i+1}.json`),
        'overlay_verbs_1.json','overlay_verbs_2.json'
      ];
      for(const name of candidates){
        try{
          const r = await fetch('./data/overlays/'+name,{cache:'no-store'});
          if(r.ok){
            const j = await r.json();
            Object.assign(dict, j);
          }
        }catch(e){}
      }
    }

    async function loadAll(){
      const hint = H('hint');
      try{
        const base = await fetchJSON('./data/dictionary.json');
        const dict = {...base};
        await loadOverlays(dict);

        // Быстрые формы (глаголы + мн. числа)
        const verbs=["eat","drink","go","come","read","write","speak","learn","love","want","know","see","work","sleep","walk","run","help","open","close","travel","call","make","give","get","need","like","use","play","watch","listen","teach","study","arrive","leave"];
        const third=s=>/(s|x|z|sh|ch)$/.test(s)?s+'es':/[^aeiou]y$/.test(s)?s.slice(0,-1)+'ies':s+'s';
        const past =s=>s.endsWith('e')?s+'d':/[^aeiou]y$/.test(s)?s.slice(0,-1)+'ied':s+'ed';
        const ing  =s=>s.endsWith('e')&&!s.endsWith('ee')?s.slice(0,-1)+'ing':s+'ing';
        verbs.forEach(v=>{[v,third(v),past(v),ing(v)].forEach(f=>{ if(f) dict[f]=dict[v]||translit(v); }); });

        const nouns=["friend","city","village","house","school","university","child","boy","girl","man","woman","doctor","shop","market","bank","ticket","hotel","room","student","teacher","book","computer","phone","project","team","player","river","forest","mountain","island","museum","theatre","airport","train","bus","cat","dog","horse","cow","bird","fish"];
        const plural=s=>/(s|x|z|sh|ch)$/.test(s)?s+'es':/[^aeiou]y$/.test(s)?s.slice(0,-1)+'ies':s+'s';
        nouns.forEach(n=>{ if(dict[n]) dict[plural(n)] = dict[n]; });

        DICT = dict;
        hint.textContent='Ready ('+Object.keys(DICT).length+' entries)';
        buildCards(); // сразу построим сет
      }catch(e){
        console.error(e);
        hint.textContent='Dictionary not found';
      }
    }

    /* -------- Translator -------- */
    function translate(){
      if(!DICT){H('hint').textContent='Dictionary not found';return;}
      const {out,unk}=mapLongest(toks(H('src').value), DICT, 4);
      H('out').textContent=finalize(out);
      H('hint').textContent = unk.length ? ('Unknown: '+[...new Set(unk)].join(', ')) : 'OK';
    }
    H('do').addEventListener('click', translate);
    H('src').addEventListener('keydown', e=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)) translate(); });

    /* -------- Assistant -------- */
    function toKomi(text){ const {out} = mapLongest(toks(text), DICT||{}, 4); return finalize(out); }
    const status = t => H('as-status').textContent=t;
    const setScore = v => H('as-bar').style.width = Math.max(0, Math.min(100, v)) + '%';

    function speakKomi(text){
      const u=new SpeechSynthesisUtterance(text);
      u.lang='ru-RU'; u.rate=0.95;
      const pick=speechSynthesis.getVoices().find(v=>/ru/i.test(v.lang))||null; if(pick) u.voice=pick;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }
    function dist(a,b){
      a=a.toLowerCase(); b=b.toLowerCase();
      const m=[]; for(let i=0;i<=a.length;i++){m[i]=[i]} for(let j=1;j<=b.length;j++) m[0][j]=j;
      for(let i=1;i<=a.length;i++){ for(let j=1;j<=b.length;j++){ m[i][j]=Math.min(m[i-1][j]+1, m[i][j-1]+1, m[i-1][j-1]+(a[i-1]==b[j-1]?0:1)); } }
      return m[a.length][b.length];
    }
    const scoreRef=(rec,ref)=>{ const d=dist(rec,ref); const max=Math.max(ref.length,1); return Math.max(0,Math.min(100,Math.round(100*(1-d/max)))); };

    document.getElementById('as-say').addEventListener('click', ()=>{
      const en=(H('as-text').value||'').trim(); if(!en) return;
      const kom = toKomi(en); speakKomi(kom); status('Repeat in Komi: "'+kom+'"');
    });
    document.getElementById('as-record').addEventListener('click', ()=>{
      const en=(H('as-text').value||'').trim(); if(!en) return;
      const target=toKomi(en);
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ status('Mic error: not supported'); return; }
      const rec=new SR(); rec.lang='ru-RU'; rec.interimResults=false; rec.maxAlternatives=1;
      status('Listening…'); H('as-record').disabled=true; setScore(0); H('as-hint').textContent='';
      rec.onresult=(e)=>{ const heard=e.results[0][0].transcript||''; const s=scoreRef(heard,target); setScore(s); status('Score: '+s+' / 100'); H('as-hint').textContent='Target: "'+target+'" | You said: "'+heard+'"'; };
      rec.onerror =(e)=>{ status('Mic error: '+(e.error||'unknown')); };
      rec.onend   =()=>{ if(H('as-status').textContent==='Listening…') status('Ready'); H('as-record').disabled=false; };
      try{ rec.start(); }catch{ status('Mic error: start failed'); H('as-record').disabled=false; }
    });

    /* -------- Cards (100) -------- */
    function pick(obj, n=100){
      const keys=Object.keys(obj).filter(k=>typeof obj[k]==='string');
      // случайная выборка без повторов
      for(let i=keys.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [keys[i],keys[j]]=[keys[j],keys[i]]; }
      return keys.slice(0,Math.min(n,keys.length));
    }
    function card(el, front, back){
      el.className='flip';
      el.innerHTML = `
        <div class="card3d">
          <div class="face front">${front}</div>
          <div class="face back">${back}</div>
        </div>`;
      el.addEventListener('click', ()=> el.firstElementChild.classList.toggle('flipit'));
    }
    function buildCards(){
      const grid=H('grid'); grid.innerHTML='';
      if(!DICT){ H('count').textContent='Dictionary not ready'; return; }
      const keys=pick(DICT,100);
      H('count').textContent=`Loaded ${Object.keys(DICT).length} entries · showing ${keys.length} cards`;
      for(const k of keys){
        const div=document.createElement('div'); card(div, k, DICT[k]); grid.appendChild(div);
      }
    }
    H('regen').addEventListener('click', buildCards);

    /* -------- boot -------- */
    loadAll();
  </script>
</body></html>






